---
date: 2020-03-03
title: Egg.js 使用 Squelize CLI 管理数据库
template: post
cover: '../cover/social-card.png'
slug: Egg.js 使用 Squelize CLI 管理数据库
categories:
  - server
  - Node
  - Egg
  - Sequelize
tags:
  - Node
  - Egg
  - Sequelize
---

## 安装

我们需要安装 `egg-sequelize` 插件和 `sequelize-cli`。

```bash
npm i egg-sequelize sequelize-cli
```

更多关于 Sequelize CLI 的指令可以通过 `npx sequelize --help` 来查看。

## Squelize CLI 配置文件

在项目根目录下配置 [.sequelizerc](https://sequelize.org/master/manual/migrations.html#the--code--sequelizerc--code--file) 文件，来指定执行 `npx sequelize *` 相关指令时的一些选项。

```js
'use strict';

const path = require('path');

module.exports = {
  'config': path.resolve('database', 'config.json'),
  'models-path': path.resolve('app', 'model'),
  'seeders-path': path.resolve('database', 'seeders'),
  'migrations-path': path.resolve('database', 'migrations')
};
```

这里我们在根目录下创建一个 `database` 文件夹，`migrations`、`senders`以及配置文件 `config.json`都放在该目录下。

按照 [Egg.js 目录约定规范](https://github.com/eggjs/egg-sequelize#model-files)，将领域模型放在 `app/model` 目录下。

## Squelize Init

```bash
npx sequelize init
```

该命令会根据 `.sequelizerc` 的配置生成对应的目录和文件。

::: warning
`app/model` 目录下会默认生成 `index.js` 文件，由于 `egg-sequelize` 插件已经做来处理，项目里不需要该文件，删除即可。
:::

### 数据库配置

在 `database/config.json` 中配置数据库，这里使用 `MySQL` 数据库配置为例：
> 需要安装 mysql2

```json
{
  "development": {
    "username": "root",
    "password": "123456",
    "database": "database_development",
    "host": "127.0.0.1",
    "port": 3306,
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": "123456",
    "database": "database_test",
    "host": "127.0.0.1",
    "port": 3306,
    "dialect": "mysql"
  }
}
```

接下来我以 **users 表**为例来学习和使用 Squelize CLI 的一些操作。

### db:create && db:drop

根据配置信息创建和删除对应的 `database`。

```bash
npx sequelize db:create
```

如果数据库已存在，`db:create` 会提示创建失败，该数据库已存在：

```bash
ERROR: Can't create database 'database_development'; database exists
```

同理，`db:drop` 也是如此。

### model:generate

创建 **model** 以及该 model 对应的 **migration**。

```bash
npx sequelize model:generate --name users --attributes username:string,password:string,mail:string
```

该命令会分别在 migrations 目录（`database/migrations`）下生成 `YYYYMMDDXXXXXX-create-users.js` 文件，model 目录（`app/model`）下生成 `users.js` 文件。

`database/migrations/20200119055615-create-users.js`

```js
'use strict';
module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.createTable('users', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER
      },
      username: {
        type: Sequelize.STRING
      },
      password: {
        type: Sequelize.STRING
      },
      mail: {
        type: Sequelize.STRING
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE
      }
    });
  },
  down: (queryInterface, Sequelize) => {
    return queryInterface.dropTable('users');
  }
};
```

::: tip
通过 `model:generate` 一并生成的 `migration` 文件的名称默认添加了 **create**。
:::

该 migration 中除了 `model:generate` 中指定的属性外，默认的添加了三个额外的属性：

- id，主键、自增、不可为空、默认类型是 `INTEGER`
- createdAt，创建时间，默认类型是 `DATE`
- updatedAt，更新时间，默认类型是 `DATE`

createdAt、updatedAt 默认是驼峰命名方式，如果想采用下划线的方式（created_at、updated_at），在 `model:generate` 指令中加上 `--underscored` 即可：

```bash
npx sequelize model:generate --name users --attributes username:string,password:string,mail:string --underscored
```

`app/model/user.js`

```js
'use strict';
module.exports = (sequelize, DataTypes) => {
  const users = sequelize.define('users', {
    username: DataTypes.STRING,
    password: DataTypes.STRING,
    mail: DataTypes.STRING
  }, {});
  users.associate = function(models) {
    // associations can be defined here
  };
  return users;
};
```

### 修改默认生成的 model 文件

Egg.js 是通过 egg-sequelize 插件来使用 Sequelize，Sequelize 对象挂载到来 app 对象下。

我们需要对 model:generate 生成的 model 做如下修改：

```js {2, 3, 4}
'use strict';
module.exports = app => {
  const { STRING } = app.Sequelize;
  const users = app.model.define('users', {
    username: STRING,
    password: STRING,
    mail: STRING
  }, {});
  users.associate = function(models) {
    // associations can be defined here
  };
  return users;
};
```

### migration:generate

创建**空的** **migration**文件

```bash
npx sequelize migration:generate --name users
```

该命令会在 migrations 目录（`database/migrations`）下生成 `YYYYMMDDXXXXXX-users.js` 文件。

::: warning
通过 `migration:generate` 生成的 `migration` 文件的名称**不会添加** **create**。
:::

`database/migrations/20200119065011-users.js`

```js
'use strict';

module.exports = {
  up: (queryInterface, Sequelize) => {
    /*
      Add altering commands here.
      Return a promise to correctly handle asynchronicity.

      Example:
      return queryInterface.createTable('users', { id: Sequelize.INTEGER });
    */
  },

  down: (queryInterface, Sequelize) => {
    /*
      Add reverting commands here.
      Return a promise to correctly handle asynchronicity.

      Example:
      return queryInterface.dropTable('users');
    */
  }
};
```

### db:migrate

`db` 开头的指令是对数据库进行操作。

```bash
npx sequelize db:migrate
```

该指令会对数据库做如下的操作：

- 创建 `SequelizeMeta` 表，该表只有一个 name 字段，name 的值是 migration 的名称
- 根据 `SequelizeMeta` 表中记录的 migration 文件，创建这些文件所对应的的表

根据前面的操作，我们会在 `database_development` 数据库中创建 `SequelizeMeta`、`users` 表。

![db_migrate](../.vuepress/public/img/egg_sequelize_cli_db_migrate.jpg)

::: danger
需要开启本地 mysql 服务，配置正确的 mysql 信息，并且配置中对应环境的本地数据库要存在
:::

#### 如果未开启 mysql 服务会报如下错误：

```bash
ERROR: connect ECONNREFUSED 127.0.0.1:3306
```

#### 如果 mysql 服务已开启，但本地数据库不存在会报如下错误：

```bash
ERROR: Unknown database 'database_development'
```

### db:migrate:undo

该指令用于对数据库进行**状态变更**。

#### 返回上一个状态

```bash
npx sequelize db:migrate:undo
```

#### 返回初始化状态

```bash
npx sequelize db:migrate:undo:all
```

该指令执行完成后，除了 `SequelizeMeta` 表外，其他表都移除了，并且 `SequelizeMeta` 也是一张**空表**。

#### 指定的表返回状态

```bash
npx sequelize db:migrate:undo --to XXXXXXXXXXXXXX-create-posts.js
npx sequelize db:migrate:undo:all --to XXXXXXXXXXXXXX-create-posts.js
```

### send:generate

有时候，我们想在某些表中插入**默认的数据**，就需要用到 senders 了。我们需要先创建一个 seeder:

```bash
npx sequelize seed:generate --name user
```

::: warning
单词拼写：seed 而不是 send，seed 是种子的意思，默认的数据就相当于一个种子，这很贴切。
:::

该指令会在 seeders 目录（`database/seeders`）下创建 `YYYYMMDDXXXXXX-user.js` 文件。

`database/seeders/20200119073843-user.js`

```js
'use strict';

module.exports = {
  up: (queryInterface, Sequelize) => {
    /*
      Add altering commands here.
      Return a promise to correctly handle asynchronicity.

      Example:
      return queryInterface.bulkInsert('Person', [{
        name: 'John Doe',
        isBetaMember: false
      }], {});
    */
  },

  down: (queryInterface, Sequelize) => {
    /*
      Add reverting commands here.
      Return a promise to correctly handle asynchronicity.

      Example:
      return queryInterface.bulkDelete('Person', null, {});
    */
  }
};
```

这里只需要根据 users 表中的字段信息，填写需要的数据即可，比如我们向 users 表中添加一条数据：

```js
'use strict';

import { md5 } from 'crypto-js';

module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert('User', [{
      username: 'Roy',
      password: md5('123456').toString(),
      mail: '17326180619@163.com'
    }], {});
  },

  down: (queryInterface, Sequelize) => {
    return queryInterface.bulkDelete('User', null, {});
  }
};
```

> 这里我们对 password `md5` 后放入数据库

### db:seed:all

将所有的 seeder 中的数据插入至对应的数据表中。

```bash
npx sequelize db:seed:add
```

### db:seed:undo

#### 撤销最近的 seed

```bash
npx sequelize db:seed:undo
```

#### 撤销特定的 seed

```bash
npx sequelize db:seed:undo --seed YYYYMMDDXXXXXX-post.js
```

#### 撤销所有的 seed

```bash
npx sequelize db:seed:undo:all
```

### Egg.js 中通过 model 进行 CRUD 操作

Egg.js 中，我们可以通过 `ctx` 拿到 `model`，然后根据指定的 model 对数据库进行增删改查操作。
