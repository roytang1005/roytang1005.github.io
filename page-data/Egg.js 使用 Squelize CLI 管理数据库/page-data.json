{"componentChunkName":"component---src-templates-post-jsx","path":"/Egg.js 使用 Squelize CLI 管理数据库/","result":{"data":{"markdownRemark":{"html":"<h2>安装</h2>\n<p>我们需要安装 <code class=\"language-text\">egg-sequelize</code> 插件和 <code class=\"language-text\">sequelize-cli</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> i egg-sequelize sequelize-cli</code></pre></div>\n<p>更多关于 Sequelize CLI 的指令可以通过 <code class=\"language-text\">npx sequelize --help</code> 来查看。</p>\n<h2>Squelize CLI 配置文件</h2>\n<p>在项目根目录下配置 <a href=\"https://sequelize.org/master/manual/migrations.html#the--code--sequelizerc--code--file\">.sequelizerc</a> 文件，来指定执行 <code class=\"language-text\">npx sequelize *</code> 相关指令时的一些选项。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'config'</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'database'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'config.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'models-path'</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'model'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'seeders-path'</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'database'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'seeders'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'migrations-path'</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'database'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'migrations'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这里我们在根目录下创建一个 <code class=\"language-text\">database</code> 文件夹，<code class=\"language-text\">migrations</code>、<code class=\"language-text\">senders</code>以及配置文件 <code class=\"language-text\">config.json</code>都放在该目录下。</p>\n<p>按照 <a href=\"https://github.com/eggjs/egg-sequelize#model-files\">Egg.js 目录约定规范</a>，将领域模型放在 <code class=\"language-text\">app/model</code> 目录下。</p>\n<h2>Squelize Init</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize init</code></pre></div>\n<p>该命令会根据 <code class=\"language-text\">.sequelizerc</code> 的配置生成对应的目录和文件。</p>\n<p>::: warning\n<code class=\"language-text\">app/model</code> 目录下会默认生成 <code class=\"language-text\">index.js</code> 文件，由于 <code class=\"language-text\">egg-sequelize</code> 插件已经做来处理，项目里不需要该文件，删除即可。\n:::</p>\n<h3>数据库配置</h3>\n<p>在 <code class=\"language-text\">database/config.json</code> 中配置数据库，这里使用 <code class=\"language-text\">MySQL</code> 数据库配置为例：</p>\n<blockquote>\n<p>需要安装 mysql2</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"development\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"database\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"database_development\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"host\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dialect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mysql\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"database\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"database_test\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"host\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dialect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mysql\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>接下来我以 <strong>users 表</strong>为例来学习和使用 Squelize CLI 的一些操作。</p>\n<h3>db:create &#x26;&#x26; db:drop</h3>\n<p>根据配置信息创建和删除对应的 <code class=\"language-text\">database</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:create</code></pre></div>\n<p>如果数据库已存在，<code class=\"language-text\">db:create</code> 会提示创建失败，该数据库已存在：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ERROR: Can<span class=\"token string\">'t create database '</span>database_development'<span class=\"token punctuation\">;</span> database exists</code></pre></div>\n<p>同理，<code class=\"language-text\">db:drop</code> 也是如此。</p>\n<h3>model:generate</h3>\n<p>创建 <strong>model</strong> 以及该 model 对应的 <strong>migration</strong>。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize model:generate --name <span class=\"token function\">users</span> --attributes username:string,password:string,mail:string</code></pre></div>\n<p>该命令会分别在 migrations 目录（<code class=\"language-text\">database/migrations</code>）下生成 <code class=\"language-text\">YYYYMMDDXXXXXX-create-users.js</code> 文件，model 目录（<code class=\"language-text\">app/model</code>）下生成 <code class=\"language-text\">users.js</code> 文件。</p>\n<p><code class=\"language-text\">database/migrations/20200119055615-create-users.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">up</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> queryInterface<span class=\"token punctuation\">.</span><span class=\"token function\">createTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      id<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        autoIncrement<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        primaryKey<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">INTEGER</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      username<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      password<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      mail<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      createdAt<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      updatedAt<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        type<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">down</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> queryInterface<span class=\"token punctuation\">.</span><span class=\"token function\">dropTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>::: tip\n通过 <code class=\"language-text\">model:generate</code> 一并生成的 <code class=\"language-text\">migration</code> 文件的名称默认添加了 <strong>create</strong>。\n:::</p>\n<p>该 migration 中除了 <code class=\"language-text\">model:generate</code> 中指定的属性外，默认的添加了三个额外的属性：</p>\n<ul>\n<li>id，主键、自增、不可为空、默认类型是 <code class=\"language-text\">INTEGER</code></li>\n<li>createdAt，创建时间，默认类型是 <code class=\"language-text\">DATE</code></li>\n<li>updatedAt，更新时间，默认类型是 <code class=\"language-text\">DATE</code></li>\n</ul>\n<p>createdAt、updatedAt 默认是驼峰命名方式，如果想采用下划线的方式（created<em>at、updated</em>at），在 <code class=\"language-text\">model:generate</code> 指令中加上 <code class=\"language-text\">--underscored</code> 即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize model:generate --name <span class=\"token function\">users</span> --attributes username:string,password:string,mail:string --underscored</code></pre></div>\n<p><code class=\"language-text\">app/model/user.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sequelize<span class=\"token punctuation\">,</span> DataTypes</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> users <span class=\"token operator\">=</span> sequelize<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    username<span class=\"token operator\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n    mail<span class=\"token operator\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  users<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">associate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">models</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// associations can be defined here</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>修改默认生成的 model 文件</h3>\n<p>Egg.js 是通过 egg-sequelize 插件来使用 Sequelize，Sequelize 对象挂载到来 app 对象下。</p>\n<p>我们需要对 model:generate 生成的 model 做如下修改：</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">app</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">STRING</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span>Sequelize<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> users <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    username<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n    mail<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  users<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">associate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">models</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// associations can be defined here</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>migration:generate</h3>\n<p>创建<strong>空的</strong> <strong>migration</strong>文件</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize migration:generate --name <span class=\"token function\">users</span></code></pre></div>\n<p>该命令会在 migrations 目录（<code class=\"language-text\">database/migrations</code>）下生成 <code class=\"language-text\">YYYYMMDDXXXXXX-users.js</code> 文件。</p>\n<p>::: warning\n通过 <code class=\"language-text\">migration:generate</code> 生成的 <code class=\"language-text\">migration</code> 文件的名称<strong>不会添加</strong> <strong>create</strong>。\n:::</p>\n<p><code class=\"language-text\">database/migrations/20200119065011-users.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">up</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*\n      Add altering commands here.\n      Return a promise to correctly handle asynchronicity.\n\n      Example:\n      return queryInterface.createTable('users', { id: Sequelize.INTEGER });\n    */</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function-variable function\">down</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*\n      Add reverting commands here.\n      Return a promise to correctly handle asynchronicity.\n\n      Example:\n      return queryInterface.dropTable('users');\n    */</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>db:migrate</h3>\n<p><code class=\"language-text\">db</code> 开头的指令是对数据库进行操作。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:migrate</code></pre></div>\n<p>该指令会对数据库做如下的操作：</p>\n<ul>\n<li>创建 <code class=\"language-text\">SequelizeMeta</code> 表，该表只有一个 name 字段，name 的值是 migration 的名称</li>\n<li>根据 <code class=\"language-text\">SequelizeMeta</code> 表中记录的 migration 文件，创建这些文件所对应的的表</li>\n</ul>\n<p>根据前面的操作，我们会在 <code class=\"language-text\">database_development</code> 数据库中创建 <code class=\"language-text\">SequelizeMeta</code>、<code class=\"language-text\">users</code> 表。</p>\n<p><img src=\"../.vuepress/public/img/egg_sequelize_cli_db_migrate.jpg\" alt=\"db_migrate\"></p>\n<p>::: danger\n需要开启本地 mysql 服务，配置正确的 mysql 信息，并且配置中对应环境的本地数据库要存在\n:::</p>\n<h4>如果未开启 mysql 服务会报如下错误：</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ERROR: connect ECONNREFUSED <span class=\"token number\">127.0</span>.0.1:3306</code></pre></div>\n<h4>如果 mysql 服务已开启，但本地数据库不存在会报如下错误：</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ERROR: Unknown database <span class=\"token string\">'database_development'</span></code></pre></div>\n<h3>db:migrate:undo</h3>\n<p>该指令用于对数据库进行<strong>状态变更</strong>。</p>\n<h4>返回上一个状态</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:migrate:undo</code></pre></div>\n<h4>返回初始化状态</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:migrate:undo:all</code></pre></div>\n<p>该指令执行完成后，除了 <code class=\"language-text\">SequelizeMeta</code> 表外，其他表都移除了，并且 <code class=\"language-text\">SequelizeMeta</code> 也是一张<strong>空表</strong>。</p>\n<h4>指定的表返回状态</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:migrate:undo --to XXXXXXXXXXXXXX-create-posts.js\nnpx sequelize db:migrate:undo:all --to XXXXXXXXXXXXXX-create-posts.js</code></pre></div>\n<h3>send:generate</h3>\n<p>有时候，我们想在某些表中插入<strong>默认的数据</strong>，就需要用到 senders 了。我们需要先创建一个 seeder:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize seed:generate --name user</code></pre></div>\n<p>::: warning\n单词拼写：seed 而不是 send，seed 是种子的意思，默认的数据就相当于一个种子，这很贴切。\n:::</p>\n<p>该指令会在 seeders 目录（<code class=\"language-text\">database/seeders</code>）下创建 <code class=\"language-text\">YYYYMMDDXXXXXX-user.js</code> 文件。</p>\n<p><code class=\"language-text\">database/seeders/20200119073843-user.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">up</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*\n      Add altering commands here.\n      Return a promise to correctly handle asynchronicity.\n\n      Example:\n      return queryInterface.bulkInsert('Person', [{\n        name: 'John Doe',\n        isBetaMember: false\n      }], {});\n    */</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function-variable function\">down</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*\n      Add reverting commands here.\n      Return a promise to correctly handle asynchronicity.\n\n      Example:\n      return queryInterface.bulkDelete('Person', null, {});\n    */</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这里只需要根据 users 表中的字段信息，填写需要的数据即可，比如我们向 users 表中添加一条数据：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> md5 <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'crypto-js'</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">up</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> queryInterface<span class=\"token punctuation\">.</span><span class=\"token function\">bulkInsert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n      username<span class=\"token operator\">:</span> <span class=\"token string\">'Roy'</span><span class=\"token punctuation\">,</span>\n      password<span class=\"token operator\">:</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token string\">'123456'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      mail<span class=\"token operator\">:</span> <span class=\"token string\">'17326180619@163.com'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function-variable function\">down</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryInterface<span class=\"token punctuation\">,</span> Sequelize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> queryInterface<span class=\"token punctuation\">.</span><span class=\"token function\">bulkDelete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>这里我们对 password <code class=\"language-text\">md5</code> 后放入数据库</p>\n</blockquote>\n<h3>db:seed:all</h3>\n<p>将所有的 seeder 中的数据插入至对应的数据表中。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:seed:add</code></pre></div>\n<h3>db:seed:undo</h3>\n<h4>撤销最近的 seed</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:seed:undo</code></pre></div>\n<h4>撤销特定的 seed</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:seed:undo --seed YYYYMMDDXXXXXX-post.js</code></pre></div>\n<h4>撤销所有的 seed</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx sequelize db:seed:undo:all</code></pre></div>\n<h3>Egg.js 中通过 model 进行 CRUD 操作</h3>\n<p>Egg.js 中，我们可以通过 <code class=\"language-text\">ctx</code> 拿到 <code class=\"language-text\">model</code>，然后根据指定的 model 对数据库进行增删改查操作。</p>","timeToRead":6,"excerpt":"安装 我们需要安装  插件和 。 更多关于 Sequelize CLI 的指令可以通过  来查看。 Squelize CLI 配置文件 在项目根目录下配置 .sequelizerc…","frontmatter":{"title":"Egg.js 使用 Squelize CLI 管理数据库","cover":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACQUlEQVQoz02S2U7jUBBELzsBsifE+57ECXY2gWCQhgdmspFBCkgIhPJA/v8fuqZvIxAPJdvXdvXprlYPDw/U7/ep2+1Su92mi4sL6vd6FIYhWZZFrVaLDMOQa6PRoHq9TtVqlUqlEp2dnVGhUKCjoyPa39+n3d1dUpvNBsPhEJ1OB+2kjbSX4urmCpeXl2BzJEkCz/MQhSF834dt2zBNE6ZhgIug2WyCi4CLgItAaaI0TYkNKY5jipOEur2uEGuxiWiQD5k+oyzLpKMgCES+55Gn5brkshSbCZ0miaJIpIk0CbcKblPIbm+v8IvJJ+MJet0UtmXDcWy+WrCY2GBaTayYAjw7MB3C4LOtn4a6JcdxkeUR+qMY+XiIbJSjl/WRsrHvB7BsD6btomWYUD/pgiiEF/hwXAcciBien5+DW+P3Mfw4RNAJ4SZcMHJ5jqbMs2VYMB0fzRYbjsdj8EyQdlK4WQBj7KJuNFCtVGXQ5XIZPBsuGiNgmlgbe77oM4wKKpUyyqUih1KEen5+xmKxwM31NZb/lpiu5rj/c4+733fI8xyj0UgovtKs1aqs2ncxnWyxWASvEE5PT6FeXl7w8fGB2WyG6d8plvMF5rM53t7eZHUeHx8lGP3xl8lPg5OTE/AugndRztR2u8VqtcJ0OsX7+zvWT0/QRdbrNV5fX6WQPl8ul/KTNtEGx8fH8nx4eAheavBSy7PSFIPBQJZ7MpnIPHWrvG9yrxMPORSHUz84OPg22NvbE5OdnR0opUT6/D8pVjIg3KWZwgAAAABJRU5ErkJggg==","aspectRatio":1.9047619047619047,"src":"/static/e8de021181594ee38f81912dc4d3a49a/af144/social-card.png","srcSet":"/static/e8de021181594ee38f81912dc4d3a49a/7c0ed/social-card.png 200w,\n/static/e8de021181594ee38f81912dc4d3a49a/647de/social-card.png 400w,\n/static/e8de021181594ee38f81912dc4d3a49a/af144/social-card.png 800w,\n/static/e8de021181594ee38f81912dc4d3a49a/ba299/social-card.png 1200w","sizes":"(max-width: 800px) 100vw, 800px"}}},"slug":"Egg.js 使用 Squelize CLI 管理数据库","date":"2020-03-03T00:00:00.000Z","categories":["server","Node","Egg","Sequelize"],"tags":["Node","Egg","Sequelize"],"template":"post"},"fields":{"slug":"/Egg.js 使用 Squelize CLI 管理数据库/","date":"2020-03-03T00:00:00.000Z"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/Egg.js 使用 Squelize CLI 管理数据库/"}}}